---
title: 怎样测试私有方法
date: 2020-08-18
categories: [开发技术, Java, 编程思想]
tags: [测试, 私有方法, 思想]
---
- [背景](#背景)
- [解法](#解法)
- [思考](#思考)
- [参考](#参考)

# 背景
对定时任务一类的功能，通常对象对外只有一个方法，在该方法内可能执行非常复杂的操作，优秀的编码者会将这种复杂方法拆分为多个私有子方法的组合。

这样虽然能保证代码结构的清晰、易读，但没法对私有方法做单元测试，直接测试复杂方法又难以保证各种情况都覆盖到，因此需要考虑是否有合理的方式能直接测试私有方法。

# 解法
1. 不测试私有方法（推荐）。
   * 可以合理设计测试用例，保证只测试公共方法就能覆盖期望的各种场景。
   * 如果仍需测试私有方法，可以重新衡量其是否为通用型方法，尝试将它重构为工具类中的公共方法。
   * 尝试让私有子方法只包含功能逻辑，将业务逻辑收敛到主方法中，从而降低或消除对私有方法单独测试的必要性。
2. 将私有（private）方法改为包可见方法（package）。
   * 让 test 代码目录下的测试类所在包与被测类所在包同名，这样测试类就能看见并使用被测类的包可见性方法。
   * 不同可见性代表不同的作用范围，进而代表方法的不同用途和目的，只因为要方便测试就改变方法可见性不太能让人接受。
3. 使用嵌套代理类。
   * 在源类内部构建包可见的嵌套类（nested class），嵌套类中各方法与外部源类的私有方法一一对应，功能实现上则只是调用外部类对应方法，即该嵌套类代理了外部类的私有方法。
   * 该方案的缺点是凭空多构建了一个嵌套类，增加理解和维护难度，同时嵌套类也容易被用于测试外的用途。
4. 利用反射。
   * JUnit 提供了 PrivilegedAccessor 等通过反射方式获取、测试私有方法的工具。
   * 反射方式是最灵活但同时也是最不可靠的，当私有方法因故被删除或方法签名有改动时，用户无法通过 IDE 对测试用例做联动更改，也不能在编译期间提前收到警告或异常；另外，反射方式下的代码可读性也比较差，不利于长期维护。

# 思考
我认为方案一是相对合理的，首先就要想办法避免测试私有方法，一是合理设计测试用例，另外也要思考方法设计上是否合理，是否存在可以改善的 Code Smell。

如果一定要测试，优先考虑方案三，虽然多加了一个嵌套类，但后期理解和维护会方便很多，而且 Idea 等 IDE 似乎也提供了便捷的标识性注解，在别的类使用了这些仅用来测试的嵌套类时 IDE 会给出异常提示。

其次是方案四，最后是方案二，原则是尽量避免修改方法原有逻辑。

# 参考
* [Testing Private Methods with JUnit and SuiteRunner](https://www.artima.com/suiterunner/private.html)
* [How to avoid the need to Unit test private methods](https://softwareengineering.stackexchange.com/questions/375860/how-to-avoid-the-need-to-unit-test-private-methods)
* [How do you unit test private methods](https://softwareengineering.stackexchange.com/questions/100959/how-do-you-unit-test-private-methods)